<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aude Analytics - GeoLab 2026</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    
<style>
    /* --- 1. VARIABLES & RESET --- */
    :root {
        --bg-main: #F8FAFC;          
        --color-vivid: #F97316;      
        --color-dark: #0F172A;       
        --text-body: #334155;        
        --glass-border: rgba(255, 255, 255, 0.6);
        --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
        
        /* Couleurs Carte */
        --c-artif: #EF4444; --c-agri: #EAB308; --c-nature: #84CC16; --c-water: #3B82F6; --c-foret: #835217;
        
        --ease-premium: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; }
    
    body, html { 
        margin: 0; padding: 0; width: 100%; height: 100%; 
        font-family: 'DM Sans', sans-serif; background-color: var(--bg-main); 
        color: var(--text-body); overflow-x: hidden; scroll-behavior: smooth;
    }

    /* Bruit de fond (Grain) */
    body::before {
        content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        pointer-events: none; z-index: 9999; mix-blend-mode: multiply;
    }

    /* --- CREDITS FIXES (NOUVEAU) --- */
    /* --- CREDITS FIXES (CORRIG√â) --- */
    .credits-fixed {
        position: fixed; bottom: 30px; left: 120px; z-index: 2000;
        display: flex; align-items: center; gap: 15px; 
        opacity: 0.8; transition: 0.3s;
        pointer-events: none; /* Laisse passer les clics au travers */
    }
    
    .credits-fixed:hover { opacity: 1; }

    /* Ligne verticale orange */
    .credits-separator {
        width: 2px; height: 35px; background: var(--color-vivid);
        border-radius: 2px;
    }

    /* Conteneur du texte */
    .credits-content {
        display: flex; flex-direction: column; justify-content: center;
    }

    .credits-title { 
        font-family: 'Playfair Display', serif; 
        font-weight: 700; 
        font-size: 1.1rem; 
        color: var(--color-dark); 
        line-height: 1; 
        margin-bottom: 2px;
    }
    
    .credits-subtitle { 
        font-family: 'DM Sans', sans-serif; 
        font-size: 0.7rem; 
        color: #64748B; 
        font-weight: 500;
    }

    /* Mode Nuit pour les cr√©dits */
    body.night .credits-title { color: #F8FAFC; }
    body.night .credits-subtitle { color: #94A3B8; }
    /* --- 2. SIDEBAR & NAVIGATION --- */
    .sidebar {
        position: fixed; left: 0; top: 0; height: 100vh; width: 80px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 2000; pointer-events: none;
    }
    .scroll-indicators { pointer-events: auto; display: flex; flex-direction: column; gap: 20px; }
    .dot { 
        width: 8px; height: 8px; background: #CBD5E1; border-radius: 50%; 
        cursor: pointer; transition: all 0.4s var(--ease-premium); 
    }
    .dot.active { background: var(--color-vivid); transform: scale(1.5); box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15); }

    .burger {
        position: fixed; top: 30px; right: 30px; width: 44px; height: 44px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; z-index: 3000; background: white; border-radius: 50%;
        box-shadow: var(--shadow-soft); transition: 0.3s; font-size: 1.2rem; color: var(--color-dark);
    }
    .burger:hover { transform: rotate(15deg); }

    /* --- 3. LAYOUT & TYPO --- */
    .main-content { width: 100%; }
    .page-section { 
        min-height: 100vh; width: 100%; display: flex; 
        position: relative; padding-left: 80px;
    }

    h1 { 
        font-family: 'Playfair Display'; font-size: 5.5rem; font-weight: 800; margin: 0; line-height: 0.9;
        color: var(--color-vivid); 
        filter: drop-shadow(0 2px 10px rgba(0,0,0,0.1));
    }
    
    h2 { font-family: 'Playfair Display'; font-size: 3.5rem; font-weight: 700; color: var(--color-dark); margin: 10px 0 30px 0; line-height: 1.1; }
    .subtitle { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 3px; color: #94A3B8; font-weight: 700; display: block; margin-bottom: 10px; }
    .description-text { font-size: 1.1rem; line-height: 1.7; color: var(--text-body); max-width: 550px; }

    /* --- 4. PAGE 1 (ACCUEIL) --- */
    #page1 { height: auto; min-height: 160vh; align-items: flex-start; }
    .p1-content { width: 50%; padding: 15vh 6% 15vh 8%; display: flex; flex-direction: column; justify-content: center; }
    .p1-map-container { 
        width: 50%; height: 100vh; background: #F8F9FA; 
        position: sticky; top: 0; right: 0; 
    }
    #map-home { height: 100%; width: 100%; opacity: 0.9; }
    .kpi-section { margin-top: 50px; display: flex; gap: 50px; padding-bottom: 40px; border-bottom: 1px solid #E2E8F0; margin-bottom: 40px; }
    .big-number { font-family: 'Playfair Display'; font-size: 3rem; font-weight: 700; color: var(--color-dark); line-height: 1; }
    .big-number span { display: block; font-family: 'DM Sans'; font-size: 0.7rem; color: #94A3B8; font-weight: 700; text-transform: uppercase; margin-top: 8px; letter-spacing: 1px; }
    .highlight { color: var(--color-vivid); font-weight: 700; }

    /* --- 5. PAGE 2 (SPLIT) --- */
    .split-layout { display: flex; width: 100%; height: 100vh; }
    .text-panel { width: 40%; padding: 0 5%; display: flex; flex-direction: column; justify-content: center; background: var(--bg-main); overflow-y: auto; z-index: 2; }
    .viz-panel { width: 60%; position: relative; display: flex; }
    
    .map-split { width: 50%; height: 100%; position: relative; border-right: 2px solid white; }
    
    .map-badge-pill {
        position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
        background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);
        padding: 8px 20px; border-radius: 30px;
        font-family: 'DM Sans'; font-size: 0.75rem; font-weight: 800; color: var(--color-dark);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 500;
        display: flex; flex-direction: column; align-items: center;
        border: 1px solid white;
    }
    .map-badge-pill span { font-size: 0.6rem; color: #64748B; font-weight: 600; text-transform: uppercase; margin-top: 2px; }

    .context-box { 
        background: white; border-radius: 12px; padding: 25px; margin: 30px 0;
        box-shadow: var(--shadow-soft); border: 1px solid #F1F5F9;
        position: relative; overflow: hidden;
    }
    .context-box::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--color-vivid); }
    .context-title { font-weight: 700; color: var(--color-dark); font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .legend-box { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 600; color: #64748B; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #E2E8F0; }
    .color-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* --- 6. PAGE 3 (DASHBOARD) --- */
    
    .map-overlay { 
        position: absolute; top: 20px; left: 20px; z-index: 1000; 
        display: flex; flex-direction: column; gap: 12px; width: 220px; 
    }

    .method-switch {
        background: white; padding: 4px; border-radius: 12px; display: flex;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05);
    }
    .method-btn {
        flex: 1; border: none; padding: 8px; border-radius: 8px; background: transparent;
        font-family: 'DM Sans'; font-weight: 600; font-size: 0.75rem; color: #64748B; cursor: pointer; transition: 0.3s;
    }
    .method-btn.active {
        background: var(--color-vivid); color: white; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.3);
    }

    .capsule-select-wrapper {
        position: relative; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
        border: 1px solid rgba(0,0,0,0.05); border-radius: 12px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: 0.3s;
    }
    .capsule-select {
        width: 100%; padding: 10px 15px; border: none; background: transparent;
        font-family: 'DM Sans'; font-size: 0.85rem; font-weight: 700; color: var(--color-dark);
        appearance: none; cursor: pointer; outline: none;
    }

    .filter-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .filter-btn { 
        border: 1px solid rgba(0,0,0,0.1); /* Bordure subtile au lieu de white */
        padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; 
        font-weight: 700; color: white; cursor: pointer; transition: 0.2s; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Ombre douce */
    }
    .filter-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .filter-btn.inactive { opacity: 0.5; filter: grayscale(1); box-shadow: none; }

    .p3-deck-area { width: 60%; height: 100%; display: flex; flex-direction: column; justify-content: center; padding-left: 5%; background: var(--bg-main); }
    .deck-container { perspective: 1200px; padding: 20px 0; overflow: visible; height: 400px; display: flex; align-items: center; }
    
    .deck-card {
        min-width: 300px; width: 300px; height: 350px;
        background: white; border-radius: 20px; 
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); border: 1px solid #F1F5F9;
        margin-right: -100px; position: relative; transition: 0.5s var(--ease-premium);
        cursor: pointer; display: flex; flex-direction: column; overflow: hidden;
        transform-style: preserve-3d;
    }
    
    .deck-card.active {
        width: 500px; min-width: 500px; margin-right: 40px;
        z-index: 50; transform: translateZ(20px) rotateY(-2deg);
        box-shadow: 0 40px 80px -20px rgba(0,0,0,0.15); border: 1px solid var(--color-vivid);
    }

    .deck-header { padding: 20px 30px; background: #FFF; border-bottom: 1px solid #F1F5F9; }
    .deck-title { font-weight: 800; color: var(--color-dark); font-size: 1.2rem; }
    .chart-content { 
        flex: 1; padding: 30px; opacity: 0; transition: 0.3s; 
        display: flex; flex-direction: column; gap: 12px;
        background: white;
    }
    .deck-card.active .chart-content { opacity: 1; transition-delay: 0.1s; }

    .chart-row { display: flex; align-items: center; font-size: 0.9rem; }
    .chart-lbl { width: 90px; text-align: right; margin-right: 15px; font-weight: 600; color: #475569; }
    .chart-bg { flex: 1; height: 10px; background: #F1F5F9; border-radius: 10px; overflow: hidden; }
    .chart-fill { height: 100%; border-radius: 10px; }
    .chart-val { width: 50px; text-align: right; font-weight: 800; color: var(--color-dark); }

    /* --- 7. PAGE 4 (STRUCTURE) --- */
    #page4 { 
        position: relative; z-index: 10; background: var(--bg-main); 
        padding: 80px 10%; flex-direction: column; justify-content: center; height: auto; min-height: 100vh;
        box-shadow: 0 -20px 50px rgba(0,0,0,0.05);
    }

    #page4 .capsule-select-wrapper {
        background: white; border: 1px solid #E2E8F0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    #page4 .capsule-select { color: var(--color-dark); }

    .treemap-section { width: 100%; margin-bottom: 40px; }
    .treemap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #E2E8F0; }
    .treemap-title { font-family: 'Playfair Display'; font-size: 1.5rem; color: var(--color-dark); margin: 0; }
    
    .tm-container { 
        width: 100%; height: 240px; display: flex; border-radius: 16px; overflow: hidden; 
        background: #F1F5F9; border: none; box-shadow: var(--shadow-soft);
    }
    .tm-item:hover { filter: brightness(1.05); transform: scale(1); z-index: 2; }

    .cta-btn {
        background: var(--color-dark); color: #919191; padding: 16px 40px; 
        border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 1rem;
        display: inline-flex; align-items: center; gap: 10px; transition: 0.3s;
        box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3);
    }
    .cta-btn:hover { background: var(--color-vivid); transform: translateY(-3px); box-shadow: 0 20px 40px -10px rgba(249, 115, 22, 0.4); }

    /* --- MODE NUIT (FIXE LISIBILITE) --- */
    body.night { --bg-main: #0F172A; --text-body: #94A3B8; --color-dark: #F8FAFC; }
    
    body.night .map-badge-pill, 
    body.night .context-box, 
    body.night .legend-item,
    body.night .method-switch,
    body.night .capsule-select-wrapper { 
        background: #1E293B; border-color: #334155; color: #F1F5F9; 
    }
    
    /* Correction Page 3 en mode nuit */
    body.night .deck-card { background: #1E293B; border-color: #334155; color: #F1F5F9; }
    body.night .deck-header { background: #1E293B; border-bottom-color: #334155; }
    body.night .deck-title { color: #F8FAFC; } /* Titre blanc */
    body.night .chart-content { background: #1E293B; }
    body.night .chart-lbl { color: #CBD5E1; }
    body.night .chart-val { color: white; }
    body.night .chart-bg { background: #334155; }
    
    /* Correction Page 4 en mode nuit */
    body.night #page4 { background: #0F172A; }
    body.night #page4 .capsule-select-wrapper { background: #1E293B; border-color: #334155; }
    body.night #page4 .capsule-select { color: #F8FAFC; } /* Texte blanc dans select */
    
    body.night .tm-container { border-color: #1E293B; background: #1E293B; }
    body.night .credits-text { color: #94A3B8; }
    body.night .credits-title { color: #F8FAFC; }
    
    path.leaflet-interactive { transition: all 0.3s ease; vector-effect: non-scaling-stroke; }
    
    #map-viz {
        height: 100%; width: 100%; background: #ebe7e0;
    }
</style>
</head>
<body>

    <aside class="sidebar">
        <div class="scroll-indicators">
            <div class="dot active" data-title="Accueil" onclick="scrollToId('page1')" id="dot1"></div>
            <div class="dot" data-title="Correction" onclick="scrollToId('page2')" id="dot2"></div>
            <div class="dot" data-title="Explorer" onclick="scrollToId('page3')" id="dot3"></div>
            <div class="dot" data-title="Structure" onclick="scrollToId('page4')" id="dot4"></div>
        </div>
    </aside>
    <div class="credits-fixed">
        <i class="fas fa-university" style="font-size:1.8rem; color:var(--text-body);"></i>
        
        <div class="credits-separator"></div>
        
        <div class="credits-content">
            <span class="credits-title">GeoLab 2026</span>
            <span class="credits-subtitle">Master OTG ¬∑ Universit√© de Strasbourg</span>
        </div>
    </div>


    <div class="burger" onclick="toggleNight()" title="Mode nuit">
        <i class="fas fa-moon"></i>
    </div>

    <div class="main-content">
        
        <section class="page-section" id="page1">
            <div class="p1-content">
                <span class="subtitle">Analyse Territoriale & G√©omatique</span>
                <h1>Aude<br>Mise √† jour.</h1>
                <hr class="separator">
                
                <p class="description-text" style="font-size:1.2rem; color:var(--color-dark); font-weight:500;">
                    Une exploration cartographique nouvelle g√©n√©ration pour comprendre l'occupation des sols, prot√©ger les zones naturelles et mesurer l'artificialisation.
                </p>

                <div class="kpi-section">
                    <div class="big-number">6 342<span>km¬≤ Superficie</span></div>
                    <div class="big-number">433<span>Communes</span></div>
                    <div class="big-number">48%<span>Espaces Naturels</span></div>
                </div>

                <div class="text-block">
                    <h3>Un Territoire de Contrastes</h3>
                    <p>
                        S'√©tendant des Pyr√©n√©es au Massif central, l'Aude est un territoire domin√© par les espaces ruraux. 
                        Tandis que la viticulture sculpte les paysages du bassin versant, les <span class="highlight">zones bois√©es et milieux semi-naturels</span> occupent pr√®s de la moiti√© du d√©partement.
                        L'artificialisation, bien que minoritaire (3%), repr√©sente un enjeu majeur de suivi pour les politiques publiques.
                    </p>
                </div>

                <div class="text-block">
                    <h3>Le D√©fi de la Donn√©e</h3>
                    <p>
                        Les r√©f√©rentiels actuels (OSO, RPG) pr√©sentent des limites √† l'√©chelle parcellaire : d√©calage temporel, confusion entre "couvert" et "usage", et impr√©cisions g√©om√©triques.
                        <br><br>
                        <strong>Notre objectif :</strong> Croiser ces sources h√©t√©rog√®nes (T√©l√©d√©tection + Donn√©es M√©tier) pour produire une classification <span class="highlight">plus robuste, automatis√©e et pr√©cise</span>.
                    </p>
                </div>
                
                <div style="margin-top:20px; color:var(--color-vivid); font-weight:700; font-size:0.9rem; display:flex; align-items:center; gap:10px;">
                    SCROLLEZ POUR D√âCOUVRIR L'ALGORITHME <i class="fas fa-arrow-down"></i>
                </div>

            </div>
            
            <div class="p1-map-container">
                <div id="map-home"></div>
            </div>
        </section>

        <section class="page-section" id="page2" style="padding:0;"> <div class="split-layout">
                <div class="text-panel" style="padding-left: 100px;"> <span class="subtitle">Diagnostic & Probl√©matique</span>
                    <h2>L'importance<br>de r√©solution.</h2>
                    
                    <div class="context-box">
                        <div class="context-title"><i class="fas fa-exclamation-triangle"></i> Le Conflit Usage vs Couverture</div>
                        <p class="context-text">
                            Les bases de donn√©es actuelles divergent souvent. 
                            <strong>L'OSO (Gauche)</strong> d√©tecte la couverture biophysique (ex: de l'herbe), tandis que <strong>COSIA (Droite)</strong> int√®gre des donn√©es m√©tiers pour comprendre l'usage r√©el (ex: un jardin priv√© est "naturel" visuellement, mais "artificialis√©" fonctionnellement).
                        </p>
                    </div>

                    <p class="description-text">
                        Dans cet exemple (Parcelle 95), la m√©thode standard classifie la zone en <strong style="color:var(--c-artif)">ARTIFICIALIS√â</strong> √† cause de la proximit√© du b√¢ti. 
                        Notre algorithme correctif, croisant RPG et T√©l√©d√©tection, la r√©affecte correctement en <strong style="color:var(--c-nature)">NATURE</strong>, modifiant ainsi le calcul final de l'artificialisation du territoire.
                    </p>

                    <div class="legend-box" style="margin-top: 30px;">
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-artif)"></div>B√¢ti/Artif</div>
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-agri)"></div>Agri</div>
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-nature)"></div>Nature</div>
                    </div>
                </div>

                <div class="viz-panel" style="display:flex;">
                    <div id="map-left" class="map-split">
                        <div class="map-badge-pill">OSO 2023 <span>(Couverture)</span></div>
                    </div>
                    <div id="map-right" class="map-split">
                        <div class="map-badge-pill">COSIA 2024 <span>(Correction IA)</span></div>
                    </div>
                </div>
            </div>

        </section>

        <section class="page-section" id="page3" style="padding:0;">
            <div class="split-layout">
                
                <div class="viz-panel" style="border-right: 1px solid #eee;">
                    <div class="map-overlay">
                        <div class="method-switch">
                            <button class="method-btn active" id="btn-m1" onclick="switchMethod('m1')">M√©thode 1 </button>
                            <button class="method-btn" id="btn-m2" onclick="switchMethod('m2')">M√©thode 2 </button>
                        </div>
                        
                        <div class="capsule-select-wrapper">
                            <select id="dalleSelector" class="capsule-select" onchange="updatePage3(this.value)">
                                <option value="" disabled selected>Chargement...</option>
                            </select>
                        </div>

                        <div class="filter-row">
                            <button class="filter-btn" style="background:var(--c-water)" onclick="toggleFilter('Eau', this)">Eau</button>
                            <button class="filter-btn" style="background:var(--c-nature)" onclick="toggleFilter('Nature', this)">Nature</button>
                            <button class="filter-btn" style="background:var(--c-foret)" onclick="toggleFilter('For√™t', this)">For√™t</button>
                            <button class="filter-btn" style="background:var(--c-agri)" onclick="toggleFilter('Agri', this)">Agri</button>
                            <button class="filter-btn" style="background:var(--c-artif)" onclick="toggleFilter('Artif', this)">Artif</button>
                        </div>
                    </div>
                    <div id="map-viz"></div>
                </div>

                <div class="text-panel">
                    <div style="padding: 40px;">
                        <span class="subtitle">Analyse Statistique</span>
                        <h2 id="dashTitle" style="margin-top:0;">Exploration<br>Probabiliste.</h2>
                        
                        <div class="context-box">
                            <div class="context-title"><i class="fas fa-chart-line"></i> Indicateur de Fiabilit√©</div>
                            <p class="context-text">
                                L'algorithme ne se contente pas de classifier, il √©value la <strong>qualit√© de sa pr√©diction</strong>.
                                Une approche statistique multidimensionnelle permettant d'identifier les zones "floues" n√©cessitant une expertise humaine.
                            </p>
                        </div>

                        <div class="deck-container" style="height: 350px; margin-top:30px;">
                            <div class="deck-card active" onclick="activateDeck(this)">
                                <div class="deck-header">
                                    <div class="deck-title" id="title-conf">Indice de Confiance</div>
                                    <span style="font-size:0.7rem; color:#888;">Score moyen (0-100)</span>
                                </div>
                                <div class="chart-content" id="chart-confiance"></div>
                            </div>

                            <div class="deck-card" onclick="activateDeck(this)" id="card-sources">
                                <div class="deck-header">
                                    <div class="deck-title">Consensus Sources</div>
                                    <span style="font-size:0.7rem; color:#888;">RPG + OSO + BD TOPO</span>
                                </div>
                                <div class="chart-content" id="chart-sources">
                                    <p style="font-size:0.8rem; color:#999;">Analyse de la concordance entre les diff√©rentes bases de donn√©es administratives pour chaque parcelle.</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </section>

        <section class="page-section" id="page4" style="flex-direction: column; padding: 80px 10%; height: auto;">
            
            <div style="margin-bottom:40px; text-align:center;">
                <span class="subtitle" style="justify-content:center;">Synth√®se Macro</span>
                <h2 style="margin-top:10px;">Structure du Territoire.</h2>
                <p class="description-text" style="margin: 0 auto;">
                    Au-del√† de la simple visualisation, cette vue synth√©tique permet de mesurer l'impact surfacique des changements m√©thodologiques √† l'√©chelle d√©partementale et d'appr√©cier la dominance des surfaces agricoles.
                </p>
            </div>

            <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                <div class="capsule-select-wrapper" style="width:250px;">
                    <select id="p4-dalleSelector" class="capsule-select" onchange="updatePage4_Top(this.value); updatePage4_Bottom(this.value);">
                        <option value="all">Vue D√©partementale (Tout)</option>
                    </select>
                </div>
            </div>

            <div class="treemap-section">
                <div class="treemap-header">
                    <h3 class="treemap-title" style="font-size:1.4rem;">M√©thode 1 </h3>
                    <span style="color:#666; font-weight:700; font-size:0.75rem; background:#eee; padding:4px 8px; border-radius:4px;">SCORE</span>
                </div>
                
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px; font-style:italic;">
                    Cette approche repose sur une fusion des indicateurs de chaque source via des scores calcul√©s pour chaque classe. La classe obtenant le score le plus √©lev√© est retenue.
                </p>

                <div class="tm-container" id="treemap-container" style="height:220px; background:var(--bg-soft);"></div>
                <div id="treemap-legend" style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; justify-content:center;"></div>
            </div>

            <div class="treemap-section">
                <div class="treemap-header">
                    <h3 class="treemap-title" style="font-size:1.4rem;">M√©thode 2 </h3>
                    <span style="color:white; background:var(--color-vivid); font-weight:700; font-size:0.75rem; padding:4px 8px; border-radius:4px;">ARBRE DE D√âCISION</span>
                </div>

                <p style="font-size:0.9rem; color:#666; margin-bottom:15px; font-style:italic;">
                    Classification affin√©e par croisement des donn√©es m√©tiers (RPG, Cadastre) et analyse probabiliste avanc√©e.
                </p>
                
                <div class="tm-container" id="treemap-container-2" style="height:220px; background:#f4f4f4;"></div>
                <div id="treemap-legend-2" style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; justify-content:center;"></div>
            </div>

            <div style="text-align:center; margin-top:60px; margin-bottom:40px;">
                <a href="map.html" class="cta-btn">
                    Acc√©der √† la Carte<i class="fas fa-database"></i>
                </a>
                <p style="margin-top:15px; font-size:0.8rem; color:#999;">Export compatible SIG (QGIS, ArcGIS) ¬∑ Projection Lambert 93</p>
            </div>

        </section>
        <div style="height:10vh;"></div>
    </div>
    
    <script>
        // --- EFFET PARALLAXE SOURIS (Page 1) ---
        const page1 = document.getElementById('page1');
        const mapContainer = document.querySelector('.p1-map-container');
        
        page1.addEventListener('mousemove', (e) => {
            const x = (window.innerWidth - e.pageX * 2) / 100;
            const y = (window.innerHeight - e.pageY * 2) / 100;
            
            // On bouge l√©g√®rement le conteneur de la carte
            mapContainer.style.transform = `translateX(${x}px) translateY(${y}px)`;
        });
        
        // On adoucit le mouvement en CSS pour √©viter les saccades
        mapContainer.style.transition = 'transform 0.1s ease-out';
        // Remplace les lignes 739-740 par √ßa :
        const URL_LIGHT = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        const URL_DARK  = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

        function updateLeafletTheme() {
            const night = document.body.classList.contains('night');
            const urlToUse = night ? URL_DARK : URL_LIGHT;

            // Liste des cartes concern√©es (Page 2 utilise le satellite, donc on ne la touche pas)
            const mapsToUpdate = [mapHome, mapViz];

            mapsToUpdate.forEach(map => {
                if (!map) return;

                // 1. On supprime UNIQUEMENT les anciennes tuiles de fond (CartoDB)
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer && layer._url && layer._url.includes('cartocdn')) {
                        map.removeLayer(layer);
                    }
                });

                // 2. On cr√©e une NOUVELLE instance unique pour cette carte pr√©cise
                L.tileLayer(urlToUse).addTo(map);
            });
        }

        // --- NAVIGATION ---
        function scrollToId(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
                    const activeId = entry.target.id;
                    const dot = document.querySelector(`.dot[onclick*="${activeId}"]`);
                    if(dot) dot.classList.add('active');
                    // Refresh carto pour √©viter les gris
                    if(activeId === 'page2') { 
                        setTimeout(() => { mapLeft.invalidateSize(); mapRight.invalidateSize(); }, 200); 
                    }
                    if(activeId === 'page3') { 
                        setTimeout(() => { mapViz.invalidateSize(); }, 200); 
                    }

                }
            });
        }, { threshold: 0.2 });
        document.querySelectorAll('.page-section').forEach(s => observer.observe(s));

        // --- PAGE 1 (MAP ACCUEIL) ---
        var mapHome = L.map('map-home', {
            zoomControl:false,
            attributionControl:false
        });

        L.tileLayer(URL_LIGHT).addTo(mapHome);

        fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements/11-aude/departement-11-aude.geojson')
        .then(r => r.json())
        .then(d => {
            const dep = L.geoJSON(d, {
                style:{
                    color:'#E89C48',
                    weight:1.5,
                    fillOpacity:0.08
                }
            }).addTo(mapHome);

            // üîë LA CL√â ABSOLUE
            mapHome.fitBounds(dep.getBounds(), {
                padding: [40,40]
            });

            // üîß sticky + scroll = recalcul obligatoire
            setTimeout(() => mapHome.invalidateSize(), 200);
        });
// ---------------------------------------------------------
        // --- 3. PAGE 2 : COMPARATEUR OSO vs COSIA (LE COEUR) ---
        // ---------------------------------------------------------

        // A. REGLAGES DE VUE (Zoom et Position)
        // -------------------------------------
        // J'ai mis le zoom √† 16 (Vue rue/quartier).
        // Ajuste les coordonn√©es [Lat, Long] si tu ne tombes pas pile sur ta zone.
        var startCenter = [43.255, 2.368]; 
        var startZoom = 16; 

        var mapLeft = L.map('map-left', {zoomControl:false, attributionControl:false}).setView(startCenter, startZoom);
        var mapRight = L.map('map-right', {zoomControl:false, attributionControl:false}).setView(startCenter, startZoom);

        // Fond Satellite (ESRI)
        var satUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
        L.tileLayer(satUrl).addTo(mapLeft);
        L.tileLayer(satUrl).addTo(mapRight);

        // Synchronisation des mouvements (Gauche <-> Droite)
        mapLeft.on('move', () => mapRight.setView(mapLeft.getCenter(), mapLeft.getZoom(), {animate:false}));
        mapRight.on('move', () => mapLeft.setView(mapRight.getCenter(), mapRight.getZoom(), {animate:false}));


        // B. DEFINITION DES COULEURS (Palette du site)
        // --------------------------------------------
        const C_ARTIF  = '#ec7a7a'; // Rouge
        const C_AGRI   = '#F2CA27'; // Jaune/Orange
        const C_NATURE = '#699a1c'; // Vert
        const C_EAU    = '#4A90E2'; // Bleu
        const C_FORET = '#835217' ; // Marron (For√™t sp√©cifique)


        // C. STYLE POUR OSO (Gauche) - Bas√© sur les codes 1 √† 23
        // ------------------------------------------------------
        function styleOSO(feature) {
            // "Classe" avec majuscule comme vu sur ta capture
            var code = feature.properties.Classe; 
            var color = C_ARTIF; // Couleur par d√©faut

            // Nomenclature OSO standard :
            // 1-2 : Artificialis√©
            if (code <= 2) color = C_ARTIF;
            
            // 11-16 : Agricole (Cultures, Vignes, Vergers...)
            else if (code >= 11 && code <= 16) color = C_AGRI;
            
            // 17-19 : For√™ts + 3-6 (Landes/Herbac√©s) -> NATURE
            else if ((code >= 17 && code <= 19) || (code >= 3 && code <= 6)) color = C_NATURE;
            
            // 23 : Eau
            else if (code === 23) color = C_EAU;

            return { fillColor: color, weight: 1, color: color, fillOpacity: 0.6 };
        }


        // D. STYLE POUR COSIA (Droite) - Bas√© sur les noms (Texte)
        // --------------------------------------------------------
        function styleCOSIA(feature) {
            // "classe" en minuscule comme vu sur ta capture
            var nom = feature.properties.classe;
            var color = C_ARTIF; // Par d√©faut

            // On utilise "includes" pour attraper les variantes (ex: "Zone imperm√©able")
            if (!nom) return { opacity:0, fillOpacity:0 }; // S√©curit√© si vide

            // 1. ARTIFICIEL (Rouge)
            if (nom.includes('imperm√©able') || 
                nom.includes('B√¢timent') || 
                nom.includes('Piscine') || 
                nom.includes('Sol nu') ||
                nom.includes('perm√©able')) { // Souvent "Zone perm√©able" = jardin urbain -> Artif dans OSO
                color = C_ARTIF;
            }

            // 2. AGRICOLE (Jaune)
            if (nom.includes('Culture') || 
                nom.includes('Vigne') || 
                nom.includes('Terre labour√©e') || 
                nom.includes('Serre')) {
                color = C_AGRI;
            }

            // 3. NATURE / FORET (Vert)
            if (nom.includes('Feuillu') || 
                nom.includes('Conif√®re') || 
                nom.includes('Pelouse') || 
                nom.includes('Broussaille')) {
                color = C_NATURE;
            }

            // 4. EAU (Bleu)
            if (nom.includes('eau')) {
                color = C_EAU;
            }

            return { fillColor: color, weight: 1, color: color, fillOpacity: 0.6 };
        }


        // E. CHARGEMENT DES FICHIERS
        // --------------------------
        function loadLayer(url, mapInstance, styleFunc, name) {
            fetch(url)
                .then(r => { if(!r.ok) throw new Error("Fichier introuvable"); return r.json(); })
                .then(data => {
                    L.geoJSON(data, { 
                        style: styleFunc,
                        // AJOUTER CECI :
                        onEachFeature: function(feature, layer) {
                            // On enl√®ve le bloc onEachFeature ou on le laisse vide
                        }
                    }).addTo(mapInstance);
                    console.log(name + " charg√© !");
                })
                .catch(e => console.error("Erreur " + name, e));
        }

        // Lancement (V√©rifie bien que tes fichiers .geojson sont dans le dossier 'donne')
        loadLayer('donne/OSO_2023_DALLE_2.geojson', mapLeft, styleOSO, 'OSO');
        loadLayer('donne/COSIA_2024_DALLE_2.geojson', mapRight, styleCOSIA, 'COSIA');

        // CADASTRE (Transparence blanche)
        var styleCadastre = { color: '#FFFFFF', weight: 1, fill: false, opacity: 0.5 };
        loadLayer('donne/CADASTRE_DALLE_2.geojson', mapLeft, styleCadastre, 'Cadastre');
        loadLayer('donne/CADASTRE_DALLE_2.geojson', mapRight, styleCadastre, 'Cadastre');
       // ---------------------------------------------------------
        // --- 4. PAGE 3 : DASHBOARD 5 CLASSES (FINAL) ---
        // ---------------------------------------------------------

        // ---------------------------------------------------------
        // --- GESTION DES DONN√âES & PAGE 3/4 ---
        // ---------------------------------------------------------

        var DALLE_ID_KEY = 'DALLE'; 
        
        // Stockage des deux datasets
        var geoDataM1 = null; // M√©thode 1
        var geoDataM2 = null; // M√©thode 2
        
        var globalGeoData = null; // Dataset actif
        var currentMethod = 'm1'; // √âtat actuel
        
        var vizLayer = null;
        var activeFilters = { 'Eau': true, 'Nature': true, 'For√™t': true, 'Agri': true, 'Artif': true };

        // 1. CHARGEMENT SIMULTAN√â DES DEUX FICHIERS
        Promise.all([
            fetch('donne/GLOBAL_DALLES.geojson').then(r => r.json()),
            fetch('donne/METHODE_2.geojson').then(r => r.json())
        ])
        .then(([dataM1, dataM2]) => {
            geoDataM1 = dataM1;
            geoDataM2 = dataM2;
            globalGeoData = geoDataM1; 

            // Init Menu Page 3
            populateDalleSelector(geoDataM1, 'dalleSelector');
    
         // Forcer la s√©lection de la premi√®re dalle disponible
            const selector = document.getElementById('dalleSelector');
            if(selector && selector.options.length > 0) {
                // On attend un tout petit peu que le DOM Leaflet soit stable
                setTimeout(() => {
                    selector.selectedIndex = 0;
                    updatePage3(selector.value);
                    mapViz.invalidateSize(); // Force le rafra√Æchissement
                }, 300);
            }

    // Init Page 4
            populateDalleSelector(geoDataM1, 'p4-dalleSelector', true);
            updatePage4_Top('all');
            updatePage4_Bottom('all');
        })
        .catch(e => console.error("Erreur chargement :", e));

        // --- 2. FONCTIONS COMMUNES (DONT POPULATEDALLESELECTOR) ---

        // C'est la fonction qui manquait !
        function populateDalleSelector(data, id, allOpt=false) {
            var s = document.getElementById(id); 
            if(!s) return;
            
            s.innerHTML = ""; // On vide le select
            
            if(allOpt) {
                var oAll = document.createElement('option'); 
                oAll.value = "all"; 
                oAll.innerText = "Vue Globale";
                s.appendChild(oAll);
            }
            
            var d = new Set();
            if(data && data.features) {
                data.features.forEach(f => { 
                    if(f.properties[DALLE_ID_KEY]) d.add(f.properties[DALLE_ID_KEY]); 
                });
            }
            
            Array.from(d).sort((a,b)=>a-b).forEach(v => {
                var o = document.createElement('option'); 
                o.value = v; 
                o.innerText = "Dalle " + v; 
                s.appendChild(o);
            });
        }

        function detectCategory(name) {
            if(!name) return 'Artif';
            var n = name.toUpperCase();
            if(n.includes('EAU')) return 'Eau';
            if(n.includes('BOIS') || n.includes('FORET')) return 'For√™t';
            if(n.includes('NATURE') || n.includes('PELOUSE')) return 'Nature';
            if(n.includes('AGRI') || n.includes('CULTURE')) return 'Agri';
            return 'Artif';
        }

        function getCategoryColor(cat) {
            switch(cat) {
                case 'Eau': return '#4A90E2'; case 'Nature': return '#699a1c';
                case 'For√™t': return '#835217'; case 'Agri': return '#F2CA27';
                case 'Artif': return '#ec7a7a'; default: return '#ccc';
            }
        }

        // --- 3. PAGE 3 : CARTE INTERACTIVE ---
        var mapViz = L.map('map-viz', {zoomControl:false}).setView([43.212, 2.355], 13);
        L.tileLayer(URL_LIGHT).addTo(mapViz);




        // FONCTION DE BASCULE (SWITCH)
        function switchMethod(m) {
            currentMethod = m;
            
            // UI Boutons
            document.getElementById('btn-m1').className = m==='m1'?'method-btn active':'method-btn';
            document.getElementById('btn-m2').className = m==='m2'?'method-btn active':'method-btn';
            
            // Swap Data
            globalGeoData = (m === 'm1') ? geoDataM1 : geoDataM2;
            
            // Gestion Fiches (Sources off en M2)
            document.getElementById('card-sources').style.display = m==='m1' ? 'flex' : 'none';
            document.getElementById('title-conf').innerText = m==='m1' ? 'Indice de Confiance' : 'Score Final';

            // Refresh P3 & P4 (Pour mettre √† jour les donn√©es affich√©es)
            var curDalle = document.getElementById('dalleSelector').value;
            if(curDalle) updatePage3(curDalle); 
        }

        function toggleFilter(cat, btn) {
            activeFilters[cat] = !activeFilters[cat];
            btn.style.opacity = activeFilters[cat]?"1":"0.4";
            if(vizLayer) vizLayer.setStyle(styleFeatureP3);
        }

        function updatePage3(dalleID) {
            if(!globalGeoData || !dalleID) return;
    
            document.getElementById('dashTitle').innerText = "Analyse Dalle " + dalleID;
    
            var filtered = globalGeoData.features.filter(f => String(f.properties[DALLE_ID_KEY]) === String(dalleID));
    
            if (vizLayer) mapViz.removeLayer(vizLayer);
    
            vizLayer = L.geoJSON({type:"FeatureCollection", features:filtered}, { 
                style: styleFeatureP3,
                onEachFeature: function(feature, layer) {
                    // On enl√®ve le bloc onEachFeature ou on le laisse vide
                }
            }).addTo(mapViz);

            if(filtered.length > 0) {
                mapViz.fitBounds(vizLayer.getBounds(), { padding: [20, 20] });
            }
    
            // Important : On force le recalcul de la taille au cas o√π le conteneur √©tait cach√©
            mapViz.invalidateSize();

            var stats = calculateStatsP3(filtered);
            renderChartP3('chart-confiance', stats, 'conf');
            if(currentMethod === 'm1') renderChartP3('chart-sources', stats, 'src');
        }

        function styleFeatureP3(f) {
            // CORRECTION ICI : 'CLASSIFICATION_FINAL' (sans E)
            var colName = currentMethod === 'm1' ? 'CLASSE_FINALE' : 'CLASSIFICATION_FINAL';
            
            var cat = detectCategory(f.properties[colName]);
            if(!activeFilters[cat]) return {opacity:0, fillOpacity:0};
            var c = getCategoryColor(cat);
            return {fillColor:c, weight:0.5, color:c, fillOpacity:0.8};
        }

        function calculateStatsP3(features) {
            var grp = {};
            
            // 1. Choix de la colonne CLASSE (Attention au "FINAL" sans E pour la m√©thode 2)
            var colClass = currentMethod === 'm1' ? 'CLASSE_FINALE' : 'CLASSIFICATION_FINAL';
            
            // 2. Choix de la colonne SCORE (C'est ici qu'on corrige !)
            // M1 -> INDICE_CONFIANCE_FINAL | M2 -> SCORE_CONFIANCE
            var colScore = currentMethod === 'm1' ? 'INDICE_CONFIANCE_FINAL' : 'SCORE_CONFIANCE';

            features.forEach(f => {
                var p = f.properties;
                
                // On r√©cup√®re la cat√©gorie
                var cat = detectCategory(p[colClass]);
                
                // Init du groupe si inexistant
                if(!grp[cat]) grp[cat] = {c:0, sConf:0, sSrc:0, color:getCategoryColor(cat)};
                
                grp[cat].c++;
                
                // --- RECUPERATION DU SCORE ---
                var val = p[colScore];
                // Petite s√©curit√© : si c'est du texte avec virgule (ex: "95,5"), on remplace par point
                if(typeof val === 'string') val = parseFloat(val.replace(',','.'));
                
                grp[cat].sConf += (val || 0);

                // --- RECUPERATION DES SOURCES (Uniquement pour M1) ---
                if(currentMethod === 'm1') {
                    var valSrc = p.NB_SOURCES_ACCORD;
                    if(typeof valSrc === 'string') valSrc = parseFloat(valSrc.replace(',','.'));
                    grp[cat].sSrc += (valSrc || 0);
                }
            });
            
            // Calcul des moyennes finales
            return Object.keys(grp).map(k=>({
                label:k, 
                color:grp[k].color,
                conf:grp[k].c ? (grp[k].sConf/grp[k].c).toFixed(1) : 0,
                src:grp[k].c ? (grp[k].sSrc/grp[k].c).toFixed(1) : 0
            })).sort((a,b)=>b.conf-a.conf);
        }

        function renderChartP3(id, data, key) {
            var el = document.getElementById(id); el.innerHTML = "";
            var max = (key==='conf')?100:5;
            data.forEach(d=>{
                var pct = (d[key]/max)*100;
                el.innerHTML += `<div class="chart-row"><div class="chart-lbl" style="width:50px;">${d.label}</div><div class="chart-bg"><div class="chart-fill" style="width:${pct}%; background:${d.color}"></div></div><div class="chart-val">${d[key]}</div></div>`;
            });
        }
        function activateDeck(el) { document.querySelectorAll('.deck-card').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }


        // =========================================================
        // 6. PAGE 4 : TREEMAPS (HAUT = M1, BAS = M2)
        // =========================================================

        // --- PARTIE HAUTE : M√âTHODE 1 (CLASSE_FINALE) ---
        function updatePage4_Top(targetDalle) {
            // On force l'utilisation de geoDataM1
            if(!geoDataM1) return; 
            if(!targetDalle) targetDalle = document.getElementById('p4-dalleSelector').value;

            // Stats M1
            var stats = { 'Eau':{area:0,c:0,col:'#4A90E2'}, 'Nature':{area:0,c:0,col:'#699a1c'}, 'For√™t':{area:0,c:0,col:'#835217'}, 'Agri':{area:0,c:0,col:'#F2CA27'}, 'Artif':{area:0,c:0,col:'#ec7a7a'} };
            var totalArea = 0;

            geoDataM1.features.forEach(f => {
                if(targetDalle !== 'all' && String(f.properties[DALLE_ID_KEY]) !== String(targetDalle)) return;
                
                // M1 utilise CLASSE_FINALE
                var cat = detectCategory(f.properties['CLASSE_FINALE']);
                var area = getApproxArea(f.geometry);
                if(stats[cat]) { stats[cat].area += area; stats[cat].c++; totalArea += area; }
            });

            drawTreemap(stats, totalArea, 'treemap-container', 'treemap-legend');
        }

        // --- PARTIE BASSE : M√âTHODE 2 (CLASSIFICATION_FINAL) ---
        function updatePage4_Bottom(targetDalle) {
            // On force l'utilisation de geoDataM2
            if(!geoDataM2) return;
            // On utilise le m√™me s√©lecteur de dalle pour que les deux graphiques bougent ensemble
            if(!targetDalle) targetDalle = document.getElementById('p4-dalleSelector').value;

            // Stats M2
            var stats = { 'Eau':{area:0,c:0,col:'#4A90E2'}, 'Nature':{area:0,c:0,col:'#699a1c'}, 'For√™t':{area:0,c:0,col:'#835217'}, 'Agri':{area:0,c:0,col:'#F2CA27'}, 'Artif':{area:0,c:0,col:'#ec7a7a'} };
            var totalArea = 0;

            geoDataM2.features.forEach(f => {
                if(targetDalle !== 'all' && String(f.properties[DALLE_ID_KEY]) !== String(targetDalle)) return;
                
                // M2 utilise CLASSIFICATION_FINAL (sans E)
                var cat = detectCategory(f.properties['CLASSIFICATION_FINAL']);
                var area = getApproxArea(f.geometry);
                if(stats[cat]) { stats[cat].area += area; stats[cat].c++; totalArea += area; }
            });

            drawTreemap(stats, totalArea, 'treemap-container-2', 'treemap-legend-2');
        }

        // --- FONCTION DE DESSIN COMMUNE ---
        // --- FONCTION DE DESSIN TREEMAP STYLE "PUZZLE" ---
        function drawTreemap(stats, totalArea, containerId, legendId) {
            var cont = document.getElementById(containerId); 
            var leg = document.getElementById(legendId);
            if(!cont || !leg) return;

            // 1. Reset et Style du conteneur (IMPORTANT pour le positionnement)
            cont.innerHTML = ""; 
            leg.innerHTML = "";
            cont.style.position = "relative"; // N√©cessaire pour les blocs absolus

            if(totalArea === 0) { 
                cont.innerHTML="<p style='padding:20px; color:#999;'>Aucune donn√©e</p>"; 
                return; 
            }

            // 2. Pr√©paration des donn√©es (Tri : du plus gros au plus petit)
            var items = Object.keys(stats)
                .map(k => ({ k: k, ...stats[k], pct: (stats[k].area / totalArea) * 100 }))
                .sort((a,b) => b.pct - a.pct);

            // 3. Algorithme de d√©coupe r√©cursive (Puzzle)
            // On d√©finit un rectangle virtuel de 0 √† 100%
            var x = 0, y = 0, w = 100, h = 100;
            var remainingArea = totalArea; // Surface restante √† placer

            items.forEach(item => {
                // M√™me si la surface est minuscule, on la traite
                if(item.area <= 0) return;

                // Calcul de la part relative dans l'espace RESTANT
                // Ex: Si Agri prend 50% du total, il prend 50% de l'espace restant au d√©but.
                // Ensuite, For√™t prend 30% du total, mais peut-√™tre 60% de l'espace qu'il reste.
                var share = item.area / remainingArea; 
                
                // S√©curit√© math√©matique (ne devrait pas arriver mais on blinde)
                if(share > 1) share = 1;

                var boxW, boxH, boxX, boxY;

                // LOGIQUE "SMART CUT" : On coupe toujours perpendiculairement au c√¥t√© le plus long
                // pour √©viter les rectangles trop fins (bandelettes).
                if (w >= h) {
                    // Plus large que haut -> Coupe Verticale (Gauche vers Droite)
                    boxW = w * share;
                    boxH = h;
                    boxX = x;
                    boxY = y;
                    
                    // On avance le curseur X et on r√©duit la largeur restante
                    x += boxW;
                    w -= boxW;
                } else {
                    // Plus haut que large -> Coupe Horizontale (Haut vers Bas)
                    boxW = w;
                    boxH = h * share;
                    boxX = x;
                    boxY = y;
                    
                    // On avance le curseur Y et on r√©duit la hauteur restante
                    y += boxH;
                    h -= boxH;
                }

                // Mise √† jour de la surface restante pour le prochain tour
                remainingArea -= item.area;

                // 4. Affichage (HTML)
                // Seuil d'affichage du texte : on ne l'affiche que si le bloc est assez gros (>3%)
                var hideText = item.pct < 3 ? 'display:none' : '';
                // Taille de police adaptative
                var fSize = item.pct < 10 ? '0.75rem' : '1.1rem';

                cont.innerHTML += `
                    <div class="tm-item" title="${item.k}: ${item.pct.toFixed(2)}% (${item.c} parcelles)" 
                         style="position:absolute; 
                                left:${boxX}%; top:${boxY}%; 
                                width:${boxW}%; height:${boxH}%; 
                                background:${item.col}; 
                                border:1px solid white; box-sizing:border-box;
                                display:flex; flex-direction:column; justify-content:center; align-items:center; 
                                color:white; overflow:hidden; transition:0.2s;">
                        
                        <div style="${hideText}; font-weight:700; font-size:${fSize}; text-shadow:0 1px 2px rgba(0,0,0,0.2); text-align:center; line-height:1.1;">
                            ${item.k}
                        </div>
                        <div style="${hideText}; font-size:${fSize}; opacity:0.9;">
                            ${item.pct.toFixed(0)}%
                        </div>
                    </div>`;

                // 5. L√©gende (Toujours compl√®te, m√™me pour l'eau √† 0%)
                leg.innerHTML += `
                    <div style="display:flex; align-items:center; gap:8px; background:var(--bg-soft); padding:6px 12px; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <div style="width:10px; height:10px; background:${item.col}; border-radius:50%;"></div>
                        <div>
                            <div style="font-weight:700; font-size:0.85rem;">${item.k}</div>
                            <div style="font-size:0.75rem; color:#666;">
                                <strong>${item.pct.toFixed(1)}%</strong> <span style="color:#aaa;">(${item.c} parcelles)</span>
                            </div>
                        </div>
                    </div>`;
            });
        }

        // OUTILS MATHS
        function getApproxArea(g) {
            if(!g||!g.coordinates) return 0;
            if(g.type==='Polygon') return polygonArea(g.coordinates[0]);
            if(g.type==='MultiPolygon') { var a=0; for(var i=0;i<g.coordinates.length;i++) a+=polygonArea(g.coordinates[i][0]); return a; }
            return 0;
        }
        function polygonArea(c) {
            var a=0; if(c.length>2){ for(var i=0;i<c.length-1;i++){ a+=(c[i][0]*81270*c[i+1][1]*111111)-(c[i+1][0]*81270*c[i][1]*111111); }} return Math.abs(a/2);
        }

        const COLORS = {
            Artif:  getComputedStyle(document.documentElement).getPropertyValue('--c-artif').trim(),
            Agri:   getComputedStyle(document.documentElement).getPropertyValue('--c-agri').trim(),
            Nature: getComputedStyle(document.documentElement).getPropertyValue('--c-nature').trim(),
            Eau:    getComputedStyle(document.documentElement).getPropertyValue('--c-water').trim(),
            Foret:  getComputedStyle(document.documentElement).getPropertyValue('--c-foret').trim()
       };

       function toggleNight() {
            document.body.classList.toggle('night');

            localStorage.setItem(
                'theme',
                document.body.classList.contains('night') ? 'night' : 'day'
            );

            updateLeafletTheme();
        }


        /* Restauration au chargement */
        (function () {
            if (localStorage.getItem('theme') === 'night') {
                document.body.classList.add('night');
                updateLeafletTheme();
            }
        })();

    </script>
</body>
</html>