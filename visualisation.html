<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aude Analytics - Final Fixed</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    
    <style>
        /* --- 1. VARIABLES --- */
        :root {
            --bg-main: #FFFEFA;
            --color-vivid: #E89C48;
            --color-dark: #1A3C34;
            --color-accent: #00B2E3;
            --text-body: #666666;
            
            /* Dataviz */
            --c-artif: #D64541; --c-agri: #F2CA27; --c-nature: #88C425; --c-water: #4A90E2;
            
            /* Treemaps */
            --tm-mint: #A0D9B4; --tm-forest: #56B880; --tm-darkblue: #3B4A6B; 
            --tm-grey: #B0B0B0; --tm-bright: #68D48E;

            /* Effects */
            --ease-premium: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'DM Sans', sans-serif; background-color: var(--bg-main); 
            color: var(--text-body); overflow-x: hidden; scroll-behavior: smooth;
        }

        /* --- 2. SIDEBAR (FONDU + INTERACTIF) --- */
        .sidebar {
            position: fixed; left: 0; top: 0; height: 100vh; width: 80px;
            background: transparent; /* Invisible */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; pointer-events: none; /* Laisse passer les clics autour */
        }
        
        .scroll-indicators { 
            pointer-events: auto; /* Réactive les clics sur les points */
            display: flex; flex-direction: column; gap: 25px; 
            padding: 10px;
        }
        
        .dot { 
            width: 10px; height: 10px; background: #D1D1D1; border-radius: 50%; 
            cursor: pointer; transition: all 0.4s var(--ease-premium); position: relative;
        }
        
        /* État Actif (Orange) */
        .dot.active { 
            background: var(--color-vivid); 
            transform: scale(1.6); 
            box-shadow: 0 0 0 4px rgba(232, 156, 72, 0.2);
        }
        
        /* Tooltip au survol */
        .dot:hover::after {
            content: attr(data-title); position: absolute; left: 25px; top: -3px;
            background: var(--color-dark); color: white; padding: 4px 8px; 
            border-radius: 4px; font-size: 0.7rem; white-space: nowrap; opacity: 1;
        }

        .burger {
            position: fixed; top: 40px; right: 40px; width: 40px; height: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px;
            cursor: pointer; z-index: 3000; background: white; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .burger div { width: 20px; height: 2px; background: var(--color-dark); border-radius: 2px; }
        .burger:hover { transform: scale(1.1); }

        /* --- 3. LAYOUT --- */
        .main-content { margin-left: 0; width: 100%; }
        .page-section { 
            min-height: 100vh; width: 100%; display: flex; 
            position: relative; border-bottom: 1px solid rgba(0,0,0,0.03); 
            padding-left: 80px;
        }

        /* TYPO */
        h1 { font-family: 'Playfair Display'; font-size: 5.5rem; font-weight: 700; color: var(--color-vivid); margin: 0; line-height: 0.9; }
        h2 { font-family: 'Playfair Display'; font-size: 3.5rem; font-weight: 700; color: var(--color-dark); margin: 15px 0 25px 0; line-height: 1.1; }
        .subtitle { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--color-vivid); font-weight: 700; display: block; margin-bottom: 15px; }
        .description-text { font-size: 1.1rem; line-height: 1.7; color: #666; max-width: 550px; margin: 0; }
        .separator { width: 60px; height: 4px; background: var(--color-vivid); border: none; margin: 30px 0; }

        /* --- 4. PAGE 1 --- */
        .p1-content { width: 50%; padding: 0 8%; display: flex; flex-direction: column; justify-content: center; }
        .p1-map-container { width: 50%; background: #F8F9FA; position: relative; }
        #map-home { height: 100%; width: 100%; mix-blend-mode: multiply; opacity: 0.8; }
        .kpi-section { margin-top: 50px; display: flex; gap: 50px; }
        .big-number { font-family: 'Playfair Display'; font-size: 4rem; font-weight: 700; color: var(--color-dark); line-height: 1; }
        .big-number span { display: block; font-family: 'DM Sans'; font-size: 0.9rem; color: #999; font-weight: 700; text-transform: uppercase; margin-top: 5px; }

        /* --- 5. PAGE 2 (SPLIT) --- */
        .compare-wrapper { width: 50%; height: 100vh; display: flex; border-left: 2px solid #fff; }
        .map-split { width: 50%; height: 100%; position: relative; border-right: 2px solid #fff; transition: width 0.4s var(--ease-premium); }
        .map-split:hover { width: 65%; }
        .map-split:hover + .map-split { width: 35%; }

        .map-badge-pill {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: #FFFFFF; padding: 8px 20px; border-radius: 50px;
            font-family: 'DM Sans'; font-size: 0.8rem; font-weight: 700; color: var(--color-dark);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); z-index: 500; white-space: nowrap;
            display: flex; flex-direction: column; align-items: center; line-height: 1.2;
        }
        .map-badge-pill span { font-size: 0.65rem; color: #999; text-transform: uppercase; letter-spacing: 1px; }

        .pedagogy-box { background: rgba(232, 156, 72, 0.08); border-left: 4px solid var(--color-vivid); padding: 25px; border-radius: 0 12px 12px 0; margin-top: 30px; display: flex; gap: 20px; }
        .legend-box { display: flex; gap: 20px; margin-top: 30px; padding: 15px 25px; background: #fff; border: 1px solid #eee; border-radius: 50px; width: fit-content; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 700; color: #555; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* --- 6. PAGE 3 (DASHBOARD) --- */
        .p3-layout { display: flex; width: 100%; height: 100vh; }
        .p3-map-area { width: 40%; height: 100%; position: relative; border-right: 1px solid #eee; }
        #map-viz { width: 100%; height: 100%; }

        .map-overlay { position: absolute; top: 30px; left: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; width: 320px; }

        .capsule-select-wrapper {
            position: relative; background: #FFFFFF; border: 1px solid #ccc;
            border-radius: 50px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .capsule-select-wrapper:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .capsule-select {
            width: 100%; padding: 14px 25px; border: none; background: transparent;
            font-family: 'DM Sans'; font-size: 1rem; font-weight: 700; color: #333;
            appearance: none; -webkit-appearance: none; cursor: pointer; outline: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 20px center; background-size: 16px;
        }

        .filter-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .filter-btn { 
            border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; 
            font-weight: 700; color: #fff; cursor: pointer; transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .filter-btn:hover { transform: translateY(-2px); }
        .filter-btn.inactive { opacity: 0.4; filter: grayscale(1); box-shadow: none; }

        .p3-deck-area { width: 60%; height: 100%; display: flex; flex-direction: column; justify-content: center; padding-left: 5%; background: #fff; }
        .kpi-row { display: flex; gap: 50px; margin: 30px 0; }
        .kpi-box { border-left: 4px solid var(--color-accent); padding-left: 20px; }
        .kpi-val { font-size: 2.5rem; font-weight: 700; color: var(--color-dark); line-height: 1; }
        .kpi-lbl { font-size: 0.8rem; font-weight: 700; color: #999; text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; }

        .deck-container { display: flex; align-items: center; height: 450px; width: 100%; position: relative; overflow-x: visible; }
        .deck-card {
            min-width: 280px; width: 280px; height: 380px;
            background: #FFF; border-radius: 16px; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03);
            margin-right: -150px; position: relative; transition: 0.5s var(--ease-premium);
            cursor: pointer; display: flex; flex-direction: column; overflow: hidden;
        }
        .deck-card:hover { transform: translateY(-10px) rotate(-1deg); z-index: 10; }
        .deck-card.active {
            min-width: 480px; width: 480px; margin-right: 40px;
            z-index: 50; transform: scale(1.05); cursor: default;
            box-shadow: 0 30px 60px rgba(0,0,0,0.12); border: 1px solid var(--color-vivid);
        }
        .deck-header { padding: 25px; background: #fafafa; border-bottom: 1px solid #f0f0f0; }
        .deck-title { font-weight: 700; color: var(--color-dark); font-size: 1.1rem; }
        .chart-content { flex: 1; padding: 30px; opacity: 0; transition: 0.3s; display: flex; flex-direction: column; gap: 15px; }
        .deck-card.active .chart-content { opacity: 1; transition-delay: 0.2s; }
        
        .chart-row { display: flex; align-items: center; font-size: 0.9rem; transition: opacity 0.3s; }
        .chart-row.dimmed { opacity: 0.15; filter: grayscale(100%); }
        .chart-lbl { width: 80px; text-align: right; margin-right: 15px; font-weight: 600; color: #888; }
        .chart-bg { flex: 1; height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .chart-fill { height: 100%; border-radius: 6px; width: 0%; transition: width 1s ease; }
        .chart-val { width: 50px; text-align: right; font-weight: 700; color: var(--color-dark); }

        /* --- 7. PAGE 4 --- */
        #page4 { padding: 0 10%; flex-direction: column; justify-content: center; }
        .treemap-section { width: 100%; margin-bottom: 50px; }
        .treemap-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .treemap-title { font-family: 'Playfair Display'; font-size: 1.8rem; color: var(--color-dark); margin: 0; }
        
        .tm-container { width: 100%; height: 260px; display: flex; gap: 4px; border-radius: 8px; overflow: hidden; }
        .tm-item { position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; cursor: default; transition: 0.3s; }
        .tm-item:hover { filter: brightness(1.1); transform: scale(1.02); z-index: 5; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .tm-col { display: flex; flex-direction: column; gap: 4px; }
        .tm-row { display: flex; gap: 4px; flex: 1; }
        .tm-lbl { font-weight: 700; font-size: 1rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tm-pct { font-size: 1.3rem; font-weight: 700; opacity: 0.9; }

        .cta-btn {
            background: var(--color-dark); color: #fff; padding: 18px 50px; 
            border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 1.1rem;
            display: inline-flex; align-items: center; gap: 10px; transition: 0.3s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 30px;
        }
        .cta-btn:hover { background: var(--color-vivid); transform: translateY(-3px); }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="scroll-indicators">
            <div class="dot active" data-title="Accueil" onclick="scrollToId('page1')" id="dot1"></div>
            <div class="dot" data-title="Correction" onclick="scrollToId('page2')" id="dot2"></div>
            <div class="dot" data-title="Explorer" onclick="scrollToId('page3')" id="dot3"></div>
            <div class="dot" data-title="Structure" onclick="scrollToId('page4')" id="dot4"></div>
        </div>
    </aside>

    <div class="burger"><div></div><div></div><div></div></div>

    <div class="main-content">
        
        <section class="page-section" id="page1">
            <div class="p1-content">
                <span class="subtitle">Analyse Géographique</span>
                <h1>Aude<br>Analytics.</h1>
                <hr class="separator">
                <p class="description-text">Une exploration cartographique nouvelle génération. Comprenez l'occupation des sols, les zones naturelles et l'évolution de l'artificialisation.</p>
                <div class="kpi-section">
                    <div class="big-number">6.139<span>km² Surface</span></div>
                    <div class="big-number">35%<span>Forêts</span></div>
                </div>
            </div>
            <div class="p1-map-container"><div id="map-home"></div></div>
        </section>

        <section class="page-section" id="page2">
            <div class="p1-content">
                <span class="subtitle">Cas d'étude</span>
                <h2>Correction<br>Algorithmique.</h2>
                <p class="description-text">La parcelle 95 passe de <strong style="color:var(--c-artif)">ARTIFICIALISÉ</strong> à <strong style="color:var(--c-nature)">NATURE</strong>.</p>
                <div class="pedagogy-box">
                    <i class="fas fa-lightbulb" style="color:var(--color-vivid); font-size:1.5rem; margin-top:2px;"></i>
                    <div>
                        <strong style="color:var(--color-dark); display:block; margin-bottom:5px;">Pourquoi c'est important ?</strong>
                        <span style="font-size:0.9rem; color:#666;">Cette visualisation met en évidence les différences entre les couches OSO 2023 et COSIA 2024. Elle illustre l’impact de la précision et de la résolution des données géographiques sur le résultat final, montrant combien ces paramètres influencent l’analyse et l’interprétation des informations spatiales.</span>
                    </div>
                </div>
                <div class="legend-box">
                    <div class="legend-item"><div class="color-dot" style="background:var(--c-artif)"></div>Agri.</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--c-agri)"></div>Artif.</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--c-nature)"></div>Nature</div>
                </div>
            </div>
            
            <div class="compare-wrapper">
                <div id="map-left" class="map-split">
                    <div class="map-badge-pill">OSO 2023 <span>(Ancien)</span></div>
                </div>
                <div id="map-right" class="map-split">
                    <div class="map-badge-pill">COSIA 2024 <span>(Corrigé)</span></div>
                </div>
            </div>
        </section>

        <section class="page-section" id="page3">
            <div class="p3-layout">
                <div class="p3-map-area">
                    <div class="map-overlay">
                        <div class="capsule-select-wrapper">
                            <select id="dalleSelector" class="capsule-select" onchange="updatePage3(this.value)">
                                <option value="" disabled selected>Chargement...</option>
                            </select>
                        </div>
                        
                        <div class="filter-row">
                            <button class="filter-btn" style="background:var(--c-water)" onclick="toggleFilter('Eau', this)">Eau</button>
                            <button class="filter-btn" style="background:#88C425" onclick="toggleFilter('Nature', this)">Nature</button>
                            <button class="filter-btn" style="background:#3E8E41" onclick="toggleFilter('Forêt', this)">Forêt</button>
                            
                            <button class="filter-btn" style="background:var(--c-agri)" onclick="toggleFilter('Agri', this)">Agri</button>
                            <button class="filter-btn" style="background:var(--c-artif)" onclick="toggleFilter('Artif', this)">Artif</button>
                        </div>
                    </div>
                    <div id="map-viz"></div>
                </div>

                <div class="p3-deck-area">
                    <span class="subtitle">Statistiques par Dalle</span>
                    <h2 style="margin:0;" id="dashTitle">Vue Globale</h2>
                    
                    <div class="deck-container">
                        <div class="deck-card active" onclick="activateDeck(this)">
                            <div class="deck-header">
                                <div class="deck-title">Indice de Confiance</div>
                                <span style="font-size:0.7rem; color:#888;">Moyenne (0-100)</span>
                            </div>
                            <div class="chart-content" id="chart-confiance"></div>
                        </div>

                        <div class="deck-card" onclick="activateDeck(this)">
                            <div class="deck-header">
                                <div class="deck-title">Sources d'Accord</div>
                                <span style="font-size:0.7rem; color:#888;">Moyenne Nb Sources</span>
                            </div>
                            <div class="chart-content" id="chart-sources"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="page-section" id="page4">
            <div style="width:100%; text-align:center;">
                <span class="subtitle" style="justify-content:center;">Vue Macro</span>
                <h2>Structure du Territoire.</h2>
            </div>
            <div style="width:100%;">
                <div class="treemap-section">
                    <div class="treemap-header"><h3 class="treemap-title">Couverture du sol</h3><span style="color:#999; font-weight:700;">NOV 2025</span></div>
                    <div class="tm-container">
                        <div class="tm-item" style="flex:51; background:var(--tm-mint);"><div class="tm-lbl">Herbacées</div><div class="tm-pct">51%</div></div>
                        <div class="tm-item" style="flex:25; background:var(--tm-forest);"><div class="tm-lbl">Forêt</div><div class="tm-pct">25%</div></div>
                        <div class="tm-col" style="flex:24;">
                            <div class="tm-row">
                                <div class="tm-item" style="flex:6; background:var(--tm-darkblue);"><div class="tm-lbl" style="font-size:0.8rem">Conifères</div></div>
                                <div class="tm-item" style="flex:5; background:var(--c-water);"><div class="tm-lbl" style="font-size:0.8rem">Eau</div></div>
                            </div>
                            <div class="tm-row">
                                <div class="tm-item" style="flex:1; background:var(--tm-bright);"></div>
                                <div class="tm-item" style="flex:1; background:var(--tm-grey);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header"><h3 class="treemap-title">Usages du sol</h3></div>
                    <div class="tm-container">
                        <div class="tm-item" style="flex:49; background:var(--tm-darkblue);"><div class="tm-lbl">Agriculture</div><div class="tm-pct">49%</div></div>
                        <div class="tm-item" style="flex:32; background:var(--tm-grey);"><div class="tm-lbl">Sylviculture</div><div class="tm-pct">32%</div></div>
                        <div class="tm-item" style="flex:10; background:var(--tm-forest);"><div class="tm-lbl">Naturel</div><div class="tm-pct">10%</div></div>
                        <div class="tm-col" style="flex:9;">
                            <div class="tm-item" style="flex:1; background:var(--tm-mint); font-size:0.7rem;">Résidentiel</div>
                            <div class="tm-row"><div class="tm-item" style="flex:1; background:var(--tm-bright);"></div><div class="tm-item" style="flex:1; background:var(--tm-bright);"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align:center; margin-top:40px;"><a href="map.html" class="cta-btn">Accéder à la Carte Interactive <i class="fas fa-arrow-right"></i></a></div>
        </section>
        <div style="height:10vh;"></div>
    </div>

    <script>
        // --- NAVIGATION ---
        function scrollToId(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
                    const activeId = entry.target.id;
                    const dot = document.querySelector(`.dot[onclick*="${activeId}"]`);
                    if(dot) dot.classList.add('active');
                    // Refresh carto pour éviter les gris
                    if(activeId === 'page2') { 
                        setTimeout(() => { mapLeft.invalidateSize(); mapRight.invalidateSize(); }, 200); 
                    }
                }
            });
        }, { threshold: 0.5 });
        document.querySelectorAll('.page-section').forEach(s => observer.observe(s));

        // --- PAGE 1 (MAP ACCUEIL) ---
        var mapHome = L.map('map-home', {zoomControl:false, attributionControl:false}).setView([43.1026, 2.4140], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapHome);
        fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements/11-aude/departement-11-aude.geojson')
        .then(r=>r.json()).then(d=>L.geoJSON(d,{style:{color:'#E89C48', weight:1, fillOpacity:0.1}}).addTo(mapHome));

// ---------------------------------------------------------
        // --- 3. PAGE 2 : COMPARATEUR OSO vs COSIA (LE COEUR) ---
        // ---------------------------------------------------------

        // A. REGLAGES DE VUE (Zoom et Position)
        // -------------------------------------
        // J'ai mis le zoom à 16 (Vue rue/quartier).
        // Ajuste les coordonnées [Lat, Long] si tu ne tombes pas pile sur ta zone.
        var startCenter = [43.255, 2.378]; 
        var startZoom = 16; 

        var mapLeft = L.map('map-left', {zoomControl:false, attributionControl:false}).setView(startCenter, startZoom);
        var mapRight = L.map('map-right', {zoomControl:false, attributionControl:false}).setView(startCenter, startZoom);

        // Fond Satellite (ESRI)
        var satUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
        L.tileLayer(satUrl).addTo(mapLeft);
        L.tileLayer(satUrl).addTo(mapRight);

        // Synchronisation des mouvements (Gauche <-> Droite)
        mapLeft.on('move', () => mapRight.setView(mapLeft.getCenter(), mapLeft.getZoom(), {animate:false}));
        mapRight.on('move', () => mapLeft.setView(mapRight.getCenter(), mapRight.getZoom(), {animate:false}));


        // B. DEFINITION DES COULEURS (Palette du site)
        // --------------------------------------------
        const C_ARTIF  = '#D64541'; // Rouge
        const C_AGRI   = '#F2CA27'; // Jaune/Orange
        const C_NATURE = '#88C425'; // Vert
        const C_EAU    = '#4A90E2'; // Bleu


        // C. STYLE POUR OSO (Gauche) - Basé sur les codes 1 à 23
        // ------------------------------------------------------
        function styleOSO(feature) {
            // "Classe" avec majuscule comme vu sur ta capture
            var code = feature.properties.Classe; 
            var color = C_ARTIF; // Couleur par défaut

            // Nomenclature OSO standard :
            // 1-2 : Artificialisé
            if (code <= 2) color = C_ARTIF;
            
            // 11-16 : Agricole (Cultures, Vignes, Vergers...)
            else if (code >= 11 && code <= 16) color = C_AGRI;
            
            // 17-19 : Forêts + 3-6 (Landes/Herbacés) -> NATURE
            else if ((code >= 17 && code <= 19) || (code >= 3 && code <= 6)) color = C_NATURE;
            
            // 23 : Eau
            else if (code === 23) color = C_EAU;

            return { fillColor: color, weight: 1, color: color, fillOpacity: 0.6 };
        }


        // D. STYLE POUR COSIA (Droite) - Basé sur les noms (Texte)
        // --------------------------------------------------------
        function styleCOSIA(feature) {
            // "classe" en minuscule comme vu sur ta capture
            var nom = feature.properties.classe;
            var color = C_ARTIF; // Par défaut

            // On utilise "includes" pour attraper les variantes (ex: "Zone imperméable")
            if (!nom) return { opacity:0, fillOpacity:0 }; // Sécurité si vide

            // 1. ARTIFICIEL (Rouge)
            if (nom.includes('imperméable') || 
                nom.includes('Bâtiment') || 
                nom.includes('Piscine') || 
                nom.includes('Sol nu') ||
                nom.includes('perméable')) { // Souvent "Zone perméable" = jardin urbain -> Artif dans OSO
                color = C_ARTIF;
            }

            // 2. AGRICOLE (Jaune)
            if (nom.includes('Culture') || 
                nom.includes('Vigne') || 
                nom.includes('Terre labourée') || 
                nom.includes('Serre')) {
                color = C_AGRI;
            }

            // 3. NATURE / FORET (Vert)
            if (nom.includes('Feuillu') || 
                nom.includes('Conifère') || 
                nom.includes('Pelouse') || 
                nom.includes('Broussaille')) {
                color = C_NATURE;
            }

            // 4. EAU (Bleu)
            if (nom.includes('eau')) {
                color = C_EAU;
            }

            return { fillColor: color, weight: 1, color: color, fillOpacity: 0.6 };
        }


        // E. CHARGEMENT DES FICHIERS
        // --------------------------
        function loadLayer(url, mapInstance, styleFunc, name) {
            fetch(url)
                .then(r => {
                    if(!r.ok) throw new Error("Fichier introuvable");
                    return r.json();
                })
                .then(data => {
                    L.geoJSON(data, { style: styleFunc }).addTo(mapInstance);
                    console.log(name + " chargé !");
                })
                .catch(e => console.error("Erreur " + name, e));
        }

        // Lancement (Vérifie bien que tes fichiers .geojson sont dans le dossier 'donne')
        loadLayer('donne/OSO_2023_DALLE_2.geojson', mapLeft, styleOSO, 'OSO');
        loadLayer('donne/COSIA_2024_DALLE_2.geojson', mapRight, styleCOSIA, 'COSIA');

        // CADASTRE (Transparence blanche)
        var styleCadastre = { color: '#FFFFFF', weight: 1, fill: false, opacity: 0.5 };
        loadLayer('donne/CADASTRE_DALLE_2.geojson', mapLeft, styleCadastre, 'Cadastre');
        loadLayer('donne/CADASTRE_DALLE_2.geojson', mapRight, styleCadastre, 'Cadastre');
       // ---------------------------------------------------------
        // --- 4. PAGE 3 : DASHBOARD 5 CLASSES (FINAL) ---
        // ---------------------------------------------------------

        var mapViz = L.map('map-viz', {zoomControl:false}).setView([43.212, 2.355], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapViz);
        
        var DALLE_ID_KEY = 'DALLE'; 
        var globalGeoData = null;
        var vizLayer = null;
        
        // ETAT DES 5 FILTRES
        var activeFilters = {
            'Eau': true,
            'Nature': true, // Pour la classe NATURE
            'Forêt': true,  // Pour la classe BOIS
            'Agri': true,   // Pour la classe AGRICULTURE
            'Artif': true   // Pour la classe ARTIFICIALISE
        };

        // CHARGEMENT
        fetch('donne/GLOBAL_DALLES.geojson')
            .then(r => r.json())
            .then(data => {
                globalGeoData = data;
                populateDalleSelector(data);
                var select = document.getElementById('dalleSelector');
                if(select.options.length > 0) {
                    select.selectedIndex = 0;
                    updatePage3(select.value);
                }
            });

        function populateDalleSelector(data) {
            var select = document.getElementById('dalleSelector');
            select.innerHTML = "";
            var dalles = new Set();
            data.features.forEach(f => {
                var val = f.properties[DALLE_ID_KEY];
                if(val !== undefined && val !== null) dalles.add(val);
            });
            Array.from(dalles).sort((a,b)=>a-b).forEach(d => {
                var opt = document.createElement('option');
                opt.value = d; opt.innerText = "Dalle " + d;
                select.appendChild(opt);
            });
        }

        // --- C. DÉTECTION DES 5 CLASSES (C'est ici que ça se joue) ---
        function detectCategory(name) {
            if(!name) return 'Autre';
            var n = name.toUpperCase(); // On met en majuscule comme dans ton fichier
            
            // 1. EAU
            if(n.includes('EAU')) return 'Eau';
            
            // 2. BOIS -> Catégorie 'Forêt'
            if(n.includes('BOIS') || n.includes('FORET')) return 'Forêt';
            
            // 3. NATURE -> Catégorie 'Nature'
            if(n.includes('NATURE')) return 'Nature';
            
            // 4. AGRICULTURE -> Catégorie 'Agri'
            if(n.includes('AGRI') || n.includes('CULTURE')) return 'Agri';
            
            // 5. ARTIFICIALISE -> Catégorie 'Artif'
            if(n.includes('ARTIF') || n.includes('BATI')) return 'Artif';
            
            return 'Artif'; // Par défaut
        }

        function getCategoryColor(cat) {
            switch(cat) {
                case 'Eau': return '#4A90E2';    // Bleu
                case 'Nature': return '#88C425'; // Vert Clair (Herbe)
                case 'Forêt': return '#3E8E41';  // Vert Foncé (Bois)
                case 'Agri': return '#F2CA27';   // Jaune
                case 'Artif': return '#D64541';  // Rouge
                default: return '#cccccc';
            }
        }

        // --- D. INTERACTION ---
        function toggleFilter(category, btnElement) {
            activeFilters[category] = !activeFilters[category];
            if(activeFilters[category]) {
                btnElement.classList.remove('inactive');
                btnElement.style.opacity = "1";
            } else {
                btnElement.classList.add('inactive');
                btnElement.style.opacity = "0.4";
            }
            if(vizLayer) vizLayer.setStyle(styleFeature);
        }

        // --- E. MISE À JOUR ---
        function updatePage3(dalleID) {
            if(!globalGeoData) return;
            document.getElementById('dashTitle').innerText = "Analyse Dalle " + dalleID;

            var filtered = globalGeoData.features.filter(f => String(f.properties[DALLE_ID_KEY]) === String(dalleID));

            if(vizLayer) mapViz.removeLayer(vizLayer);
            vizLayer = L.geoJSON({type:"FeatureCollection", features:filtered}, {
                style: styleFeature
            }).addTo(mapViz);
            
            if(filtered.length > 0) mapViz.fitBounds(vizLayer.getBounds());

            var stats = calculateStats(filtered);
            renderChart('chart-confiance', stats, 'conf');
            renderChart('chart-sources', stats, 'src');
        }

        function styleFeature(feature) {
            var rawName = feature.properties.CLASSE_FINALE || "";
            var cat = detectCategory(rawName);
            
            if(activeFilters[cat] === false) {
                return { fillOpacity: 0, opacity: 0, stroke: false }; 
            }
            var col = getCategoryColor(cat);
            return { fillColor: col, weight: 0.5, color: col, fillOpacity: 0.8 };
        }

        // --- F. STATISTIQUES (CORRIGÉE : NOMS DE COLONNES EXACTS) ---
        function calculateStats(features) {
            var groups = {};

            features.forEach(f => {
                var p = f.properties;
                var rawName = p.CLASSE_FINALE || "Inconnu";
                
                // On récupère la catégorie (Forêt, Agri...)
                var cat = detectCategory(rawName); 
                var col = getCategoryColor(cat);

                // Initialisation si la catégorie n'existe pas encore
                if(!groups[cat]) { 
                    groups[cat] = { count:0, sumConf:0, sumSrc:0, color: col };
                }

                // --- C'EST ICI QUE CA PLANTAIT AVANT ---
                
                // 1. INDICE_CONFIANCE_FINAL (Sans 'DE')
                // On vérifie si c'est un nombre direct ou une chaine
                var valConf = p.INDICE_CONFIANCE_FINAL; 
                var conf = 0;
                if (typeof valConf === 'number') {
                    conf = valConf;
                } else if (typeof valConf === 'string') {
                    conf = parseFloat(valConf.replace(',', '.'));
                }

                // 2. NB_SOURCES_ACCORD (Singulier)
                var valSrc = p.NB_SOURCES_ACCORD;
                var src = 0;
                if (typeof valSrc === 'number') {
                    src = valSrc;
                } else if (typeof valSrc === 'string') {
                    src = parseFloat(valSrc.replace(',', '.'));
                }

                // On ajoute aux totaux
                groups[cat].count++;
                groups[cat].sumConf += conf;
                groups[cat].sumSrc += src;
            });

            // Calcul des moyennes et tri
            return Object.keys(groups).map(k => {
                var g = groups[k];
                return {
                    label: k, // "Forêt", "Nature", "Agri"...
                    color: g.color,
                    // toFixed(1) pour avoir 1 chiffre après la virgule (ex: 85.4)
                    conf: g.count ? (g.sumConf / g.count).toFixed(1) : 0,
                    src: g.count ? (g.sumSrc / g.count).toFixed(1) : 0
                };
            }).sort((a,b) => b.conf - a.conf); // Tri par indice de confiance
        }

        function renderChart(id, data, key) {
            var el = document.getElementById(id);
            el.innerHTML = "";
            var max = (key === 'conf') ? 100 : 5; 
            data.forEach(d => {
                var pct = (d[key] / max) * 100;
                el.innerHTML += `
                    <div class="chart-row">
                        <div class="chart-lbl" style="width:50px; font-size:0.8rem;">${d.label}</div>
                        <div class="chart-bg"><div class="chart-fill" style="width:${pct}%; background:${d.color}"></div></div>
                        <div class="chart-val">${d[key]}</div>
                    </div>`;
            });
        }
        
        function activateDeck(el) {
            document.querySelectorAll('.deck-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
</body>
</html>